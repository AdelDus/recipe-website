{% extends 'game/base.html' %}

{% block title %}{{ recipe.title }} - –°–∞–π—Ç —Ä–µ—Ü–µ–ø—Ç–æ–≤{% endblock %}

{% block content %}
<a href="{% url 'home' %}" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É —Ä–µ—Ü–µ–ø—Ç–æ–≤</a>

<div class="recipe-detail">
    <div class="recipe-header">
        <h2>{{ recipe.title }}</h2>
        {% if recipe.category %}
            <div class="recipe-category">
                <a href="{% url 'home' %}?category={{ recipe.category.id }}">
                    {{ recipe.category.icon }} {{ recipe.category.name }}
                </a>
            </div>
        {% endif %}
        <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}" class="recipe-image">
        <div class="recipe-meta">
            <span>‚è±Ô∏è –í—Ä–µ–º—è: {{ recipe.cooking_time }} –º–∏–Ω—É—Ç</span>
            <span>üçΩÔ∏è –ü–æ—Ä—Ü–∏–π: {{ recipe.servings }}</span>
        </div>
        <p class="recipe-description">{{ recipe.description }}</p>
        
        <div style="text-align: center; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <form method="post" action="{% url 'like_recipe' recipe.id %}" id="like-form">
                {% csrf_token %}
                <button type="submit" class="like-button">
                    <span>‚ù§Ô∏è</span>
                    <span>–ù—Ä–∞–≤–∏—Ç—Å—è</span>
                    <span class="like-count" id="like-count">{{ recipe.likes }}</span>
                </button>
            </form>
            
            <button class="favorite-button {% if is_favorite %}active{% endif %}" id="favorite-btn" data-recipe-id="{{ recipe.id }}">
                <span>‚≠ê</span>
                <span id="favorite-text">{% if is_favorite %}–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º{% else %}–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ{% endif %}</span>
            </button>
        </div>
    </div>

    <div class="section">
        <h3>üìù –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</h3>
        <ul class="ingredients-list">
            {% for ingredient in ingredients %}
                <li>{{ ingredient.name }} ‚Äî {{ ingredient.quantity }} {{ ingredient.unit }}</li>
            {% empty %}
                <li>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã</li>
            {% endfor %}
        </ul>
    </div>

    <div class="section">
        <h3>üë®‚Äçüç≥ –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h3>
        <ul class="steps-list">
            {% for step in steps %}
                <li>{{ step.instruction }}</li>
            {% empty %}
                <li>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã</li>
            {% endfor %}
        </ul>
    </div>

    <div class="section">
        <h3>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ comments.count }})</h3>
        
        {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    <div class="message {{ message.tags }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
        
        <div class="comment-form">
            <h4>–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h4>
            <form method="post">
                {% csrf_token %}
                <div class="form-group">
                    <input type="text" name="author_name" placeholder="–í–∞—à–µ –∏–º—è" required maxlength="100">
                </div>
                <div class="form-group">
                    <textarea name="text" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" required rows="4"></textarea>
                </div>
                <button type="submit" class="submit-comment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>

        <div class="comments-list">
            {% for comment in comments %}
                <div class="comment">
                    <div class="comment-header">
                        <strong class="comment-author">{{ comment.author_name }}</strong>
                        <span class="comment-date">{{ comment.created_at|date:"d.m.Y H:i" }}</span>
                    </div>
                    <p class="comment-text">{{ comment.text }}</p>
                </div>
            {% empty %}
                <p class="no-comments">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
            {% endfor %}
        </div>
    </div>
</div>

<script>
// –õ–∞–π–∫–∏
document.getElementById('like-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = this;
    const button = form.querySelector('.like-button');
    const countElement = document.getElementById('like-count');
    
    fetch(form.action, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        countElement.textContent = data.likes;
        button.style.animation = 'pulse 0.3s';
        setTimeout(() => button.style.animation = '', 300);
    })
    .catch(error => console.error('Error:', error));
});

// –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
document.getElementById('favorite-btn').addEventListener('click', function() {
    const recipeId = this.dataset.recipeId;
    const url = `/recipe/${recipeId}/favorite/`;
    const button = this;
    const textElement = document.getElementById('favorite-text');
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        button.classList.toggle('active');
        textElement.textContent = data.is_favorite ? '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º' : '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
        button.style.animation = 'pulse 0.3s';
        setTimeout(() => button.style.animation = '', 300);
    })
    .catch(error => console.error('Error:', error));
});
</script>
{% endblock %}
